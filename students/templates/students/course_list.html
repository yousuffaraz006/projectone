{% extends "students/base.html" %}

{% block title %}Courses{% endblock %}

{% block breadcrumbs %}
<ol class="breadcrumb mb-0">
    <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
    <li class="breadcrumb-item active">Courses</li>
</ol>
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between mb-3">
    <h4>Courses</h4>
    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#addCourseModal">
        <i class="bi bi-plus-circle"></i> Add Course
    </button>
</div>

<div class="card shadow-sm">
    <div class="card-body p-0">
        <table class="table table-striped mb-0">
            <thead class="table-dark">
                <tr>
                    <th>Code</th>
                    <th>Title</th>
                    <th>Teacher</th>
                    <th>Semester</th>
                    <th class="text-center">Action</th>
                </tr>
            </thead>
            <tbody>
            {% for course in courses %}
                <tr>
                    <td>{{ course.course_code }}</td>
                    <td>{{ course.title }}</td>
                    <td>{{ course.teacher|default:"—" }}</td>
                    <td>{{ course.semester|default:"—" }}</td>
                    <td class="text-center">
                        <a href="#" class="text-primary me-3"
                           data-bs-toggle="modal"
                           data-bs-target="#editCourseModal"
                           data-id="{{ course.id }}"
                           data-code="{{ course.course_code }}"
                           data-title="{{ course.title }}"
                           data-desc="{{ course.description }}"
                           data-credits="{{ course.credits }}"
                           data-semester="{{ course.semester }}"
                           data-year="{{ course.academic_year }}"
                           data-teacher="{{ course.teacher_id }}"
                           data-students="{% for s in course.students.all %}{{ s.id }},{% endfor %}">
                            <i class="bi bi-pencil-square"></i>
                        </a>
                        <a href="#"
                        class="text-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#confirmDeleteModal"
                        data-delete-url="{% url 'course_delete' course.id %}"
                        data-object-name="{{ course.course_code }} - {{ course.title }}">
                            <i class="bi bi-trash"></i>
                        </a>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="5" class="text-center py-4">No courses found</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ADD COURSE MODAL -->
<div class="modal fade" id="addCourseModal">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <form method="post" action="{% url 'course_create' %}" class="modal-content">
            {% csrf_token %}
            <div class="modal-header bg-warning">
                <h5>Add Course</h5>
                <button class="btn-close" type="reset" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body row g-3">
                <div class="col-md-6">{{ form.course_code.label_tag }}{{ form.course_code }}</div>
                <div class="col-md-6">{{ form.title.label_tag }}{{ form.title }}</div>
                <div class="col-md-12">{{ form.description.label_tag }}{{ form.description }}</div>
                <div class="col-md-4">{{ form.credits.label_tag }}{{ form.credits }}</div>
                <div class="col-md-4">{{ form.semester.label_tag }}{{ form.semester }}</div>
                <div class="col-md-4">{{ form.academic_year.label_tag }}{{ form.academic_year }}</div>
                <div class="col-md-12">{{ form.teacher.label_tag }}{{ form.teacher }}</div>
                <div class="col-md-12">{{ form.students.label_tag }}{{ form.students }}
                    <small class="text-muted">Hold Ctrl (or Cmd) to select multiple students</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="reset" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-warning">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- EDIT COURSE MODAL -->
<div class="modal fade" id="editCourseModal">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <form method="post" id="editCourseForm" class="modal-content">
            {% csrf_token %}
            <div class="modal-header bg-warning">
                <h5>Edit Course</h5>
                <button class="btn-close" type="reset" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body row g-3">
                <div class="col-md-6"><input class="form-control" name="course_code" id="cCode"></div>
                <div class="col-md-6"><input class="form-control" name="title" id="cTitle"></div>
                <div class="col-md-12"><textarea class="form-control" name="description" id="cDesc"></textarea></div>
                <div class="col-md-4"><input class="form-control" name="credits" id="cCredits"></div>
                <div class="col-md-4"><input class="form-control" name="semester" id="cSemester"></div>
                <div class="col-md-4"><input class="form-control" name="academic_year" id="cYear"></div>
                <div class="col-md-12">
                    <select class="form-select" name="teacher" id="cTeacher" required>
                        <option value="">-----</option>
                        {% for teacher in form.fields.teacher.queryset %}
                        <option value="{{ teacher.id }}">{{ teacher }}</option>
                        {% endfor %}
                    </select>
                </div>
                <select class="form-select" name="students" id="cStudents" multiple required>
                    {% for student in form.fields.students.queryset %}
                        <option value="{{ student.id }}">{{ student }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="reset" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-warning">Update</button>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('editCourseModal').addEventListener('show.bs.modal', function (e) {
    const b = e.relatedTarget;
    editCourseForm.action = `/courses/edit/${b.dataset.id}/`;

    cCode.value = b.dataset.code;
    cTitle.value = b.dataset.title;
    cDesc.value = b.dataset.desc || '';
    cCredits.value = b.dataset.credits || '';
    cSemester.value = b.dataset.semester || '';
    cYear.value = b.dataset.year || '';
    cTeacher.value = b.dataset.teacher || '';

    const selectedStudents = (b.dataset.students || '').split(',').filter(Boolean);
    const options = document.getElementById('cStudents').options;

    for (let option of options) {
        option.selected = selectedStudents.includes(option.value);
    }
});
</script>

{% endblock %}
