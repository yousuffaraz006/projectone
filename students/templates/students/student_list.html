{% extends "students/base.html" %}

{% block title %}Students{% endblock %}

{% block breadcrumbs %}
<ol class="breadcrumb mb-0">
    <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
    <li class="breadcrumb-item active">Students</li>
</ol>
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between mb-3">
    <h4>Students</h4>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
        <i class="bi bi-plus-circle"></i> Add Student
    </button>
</div>

<div class="card shadow-sm">
    <div class="card-body p-0">
        <table class="table table-striped mb-0">
            <thead class="table-dark">
                <tr>
                    <th>Name</th>
                    <th>Roll</th>
                    <th>Program</th>
                    <th class="text-center">Action</th>
                </tr>
            </thead>
            <tbody>
            {% for student in students %}
                <tr>
                    <td>{{ student.first_name }} {{ student.last_name }}</td>
                    <td>{{ student.roll_number }}</td>
                    <td>{{ student.program|default:"â€”" }}</td>
                    <td class="text-center">
                        <a href="#"
                        class="text-info me-3"
                        data-bs-toggle="modal"
                        data-bs-target="#studentCoursesModal"
                        data-student-name="{{ student.first_name }} {{ student.last_name }}"
                        data-courses="{% for c in student.courses.all %}{{ c.course_code }} - {{ c.title }}||{% endfor %}">
                            <i class="bi bi-journal-bookmark"></i>
                        </a>
                        <a href="#" class="text-primary me-3"
                           data-bs-toggle="modal"
                           data-bs-target="#editStudentModal"
                           data-id="{{ student.id }}"
                           data-fname="{{ student.first_name }}"
                           data-lname="{{ student.last_name }}"
                           data-roll="{{ student.roll_number }}"
                           data-email="{{ student.email }}"
                           data-program="{{ student.program }}"
                           data-year="{{ student.admission_year }}"
                           data-dob="{{ student.date_of_birth|date:'Y-m-d' }}">
                            <i class="bi bi-pencil-square"></i>
                        </a>
                        <a href="#"
                        class="text-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#confirmDeleteModal"
                        data-delete-url="{% url 'student_delete' student.id %}"
                        data-object-name="{{ student.first_name }} {{ student.last_name }}">
                            <i class="bi bi-trash"></i>
                        </a>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="4" class="text-center py-4">No students found</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- STUDENT COURSES MODAL -->
<div class="modal fade" id="studentCoursesModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    Courses for <span id="studentCoursesName"></span>
                </h5>
                <button type="reset" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <ul class="list-group" id="studentCoursesList">
                    <!-- populated via JS -->
                </ul>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">
                    Close
                </button>
            </div>

        </div>
    </div>
</div>

<!-- ADD STUDENT MODAL -->
<div class="modal fade" id="addStudentModal">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <form method="post" action="{% url 'student_create' %}" class="modal-content">
            {% csrf_token %}
            <div class="modal-header bg-primary text-white">
                <h5>Add Student</h5>
                <button type="reset" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body row g-3">
                <div class="col-md-6">{{ form.first_name.label_tag }}{{ form.first_name }}</div>
                <div class="col-md-6">{{ form.last_name.label_tag }}{{ form.last_name }}</div>
                <div class="col-md-6">{{ form.roll_number.label_tag }}{{ form.roll_number }}</div>
                <div class="col-md-6">{{ form.email.label_tag }}{{ form.email }}</div>
                <div class="col-md-6">{{ form.program.label_tag }}{{ form.program }}</div>
                <div class="col-md-6">{{ form.admission_year.label_tag }}{{ form.admission_year }}</div>
                <div class="col-md-6">{{ form.date_of_birth.label_tag }}{{ form.date_of_birth }}</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="reset" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- EDIT STUDENT MODAL -->
<div class="modal fade" id="editStudentModal">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <form method="post" id="editForm" class="modal-content">
            {% csrf_token %}
            <div class="modal-header bg-primary text-white">
                <h5>Edit Student</h5>
                <button type="reset" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body row g-3">
                <input type="hidden" id="editId">
                <div class="col-md-6"><input class="form-control" name="first_name" id="editFname"></div>
                <div class="col-md-6"><input class="form-control" name="last_name" id="editLname"></div>
                <div class="col-md-6"><input class="form-control" name="roll_number" id="editRoll"></div>
                <div class="col-md-6"><input class="form-control" name="email" id="editEmail"></div>
                <div class="col-md-6"><input class="form-control" name="program" id="editProgram"></div>
                <div class="col-md-6"><input class="form-control" name="admission_year" id="editYear"></div>
                <div class="col-md-6"><input type="date" class="form-control" name="date_of_birth" id="editDob"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="reset" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary">Update</button>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('editStudentModal').addEventListener('show.bs.modal', e => {
    const b = e.relatedTarget;
    editForm.action = `/students/edit/${b.dataset.id}/`;
    editFname.value = b.dataset.fname;
    editLname.value = b.dataset.lname;
    editRoll.value = b.dataset.roll;
    editEmail.value = b.dataset.email;
    editProgram.value = b.dataset.program || '';
    editYear.value = b.dataset.year || '';
    editDob.value = b.dataset.dob || '';
});
document.getElementById('studentCoursesModal').addEventListener('show.bs.modal', function (e) {
    const button = e.relatedTarget;
    const studentName = button.getAttribute('data-student-name');
    const coursesRaw = button.getAttribute('data-courses');

    document.getElementById('studentCoursesName').innerText = studentName;

    const list = document.getElementById('studentCoursesList');
    list.innerHTML = '';

    if (!coursesRaw) {
        list.innerHTML = `
            <li class="list-group-item text-muted">
                No courses enrolled
            </li>`;
        return;
    }

    const courses = coursesRaw.split('||').filter(Boolean);

    courses.forEach(course => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.innerText = course;
        list.appendChild(li);
    });
});
</script>

{% endblock %}
